# 量化交易系统 - 回测与实盘流程文档

## 概述

本文档描述股票量化交易系统的回测和实盘交易流程。系统采用多策略组合，根据市场环境（牛市/熊市/震荡市）自动选择合适的交易策略。

---

## 一、数据准备

### 1.1 数据源

系统使用SQLite数据库存储历史数据，数据来源为Tushare Pro。

### 1.2 数据表结构

#### 日线数据 (daily)
| 字段 | 类型 | 说明 |
|------|------|------|
| ts_code | TEXT | 股票代码 (e.g., 600809.SH) |
| trade_date | TEXT | 交易日期 (YYYYMMDD) |
| open | REAL | 开盘价 |
| high | REAL | 最高价 |
| low | REAL | 最低价 |
| close | REAL | 收盘价 |
| vol | REAL | 成交量 (手) |
| amount | REAL | 成交额 (元) |

#### 基本面数据 (fundamentals)
| 字段 | 类型 | 说明 |
|------|------|------|
| ts_code | TEXT | 股票代码 |
| pe | REAL | 市盈率 |
| roe | REAL | 净资产收益率 (%) |
| dv_ratio | REAL | 股息率 (%) |
| debt_to_asset | REAL | 资产负债率 (%) |
| market_cap | REAL | 总市值 (亿元) |

### 1.3 数据清洗规则

1. **活跃股票筛选**: 60天日均成交额 ≥ 3000万元
2. **指数数据**: 使用沪深300指数(000300.SH)判断市场环境
3. **复权处理**: 使用前复权数据

---

## 二、实盘交易流程

### 2.1 开盘前准备 (每日盘前运行)

```
┌─────────────────────────────────────────────────────────────────┐
│  开盘前流程 (run_trading.py --mode pre)                         │
├─────────────────────────────────────────────────────────────────┤
│  1. 获取活跃股票                                                 │
│     └─ 条件: 60天日均成交额 >= 3000万                           │
│                                                                 │
│  2. 基本面筛选                                                   │
│     ├─ PE < 25                                                  │
│     ├─ ROE > 10%                                               │
│     ├─ 股息率 > 1%                                              │
│     ├─ 资产负债率 < 70%                                         │
│     └─ 总市值 > 30亿元                                          │
│                                                                 │
│  3. 市场环境检测                                                 │
│     ├─ 读取沪深300指数数据                                       │
│     ├─ 计算60日均线                                              │
│     ├─ 计算MACD指标                                             │
│     ├─ 计算RSI指标                                              │
│     └─ 判定: 牛市 / 熊市 / 震荡市                               │
│                                                                 │
│  4. 持仓检查                                                     │
│     ├─ 获取当前持仓                                              │
│     ├─ 检测市场环境变化                                          │
│     └─ 必要时卖出                                                │
│                                                                 │
│  5. 选股买入                                                     │
│     ├─ 根据市场环境选择策略                                       │
│     ├─ 计算信号分数                                              │
│     ├─ 排序选股                                                  │
│     └─ 买入信号最强的股票                                         │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 交易参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 初始资金 | 100万 | |
| 单股仓位 | 10% | 每只股票最多占总资金10% |
| 最大持仓 | 5只 | 最多同时持有5只股票 |
| 止盈 | 20% | 收益达到20%时卖出 |
| 止损 | -10% | 亏损达到10%时卖出 |
| 买入间隔 | 10天 | 两次买入操作至少间隔10天 |

### 2.3 市场环境与策略选择

| 市场环境 | 策略选择 | 说明 |
|----------|----------|------|
| 牛市 | 趋势跟踪策略 | 成交量突破、MACD、均线发散等 |
| 熊市 | 逆势反弹策略 | RSI逆势、威廉指标、双底形态等 |
| 震荡市 | 区间震荡策略 | 布林带、支撑阻力、均线收复等 |

### 2.4 买入流程详解

```
买入流程:
1. 计算每只候选股票的技术信号分数
2. 按分数降序排列
3. 选择分数最高的股票
4. 检查资金是否充足 (至少10万)
5. 按100股整数倍买入
6. 扣除手续费 (千分之一)
```

### 2.5 卖出触发条件

1. **止盈**: 收益 ≥ 20%
2. **止损**: 亏损 ≤ -10%
3. **市场环境变化**: 当前持仓策略不再适合新市场环境
4. **持仓到期**: 持仓超过60个交易日

---

## 三、回测流程

### 3.1 回测系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│  统一回测系统 (unified_backtest.py)                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  数据加载模块                                                   │
│  ├─ 加载日期范围 (默认2016-01-01 ~ 2019-12-31)                │
│  ├─ 加载日线数据 (每日成交额前100股票)                         │
│  └─ 加载基本面数据                                              │
│                                                                 │
│  策略引擎模块                                                   │
│  ├─ 市场环境检测                                               │
│  ├─ 策略选择                                                   │
│  └─ 信号计算                                                   │
│                                                                 │
│  交易模拟模块                                                   │
│  ├─ 开仓/平仓逻辑                                              │
│  ├─ 止盈止损                                                  │
│  └─ 持仓管理                                                  │
│                                                                 │
│  结果分析模块                                                   │
│  ├─ 计算收益率                                                 │
│  ├─ 计算回撤                                                  │
│  └─ 统计交易次数                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 回测参数配置

```python
class BacktestConfig:
    # 资金参数
    initial_capital = 1_000_000      # 初始资金 100万
    
    # 交易参数
    tp = 0.20                        # 止盈 20%
    sl = 0.10                        # 止损 10%
    signal_threshold = 20            # 信号阈值
    max_stocks_per_day = 100         # 每日处理股票数
    
    # 选股参数
    max_positions = 5                # 最大持仓数
    position_size = 0.10             # 单股仓位 10%
    buy_interval = 10                # 买入间隔天数
```

### 3.3 回测流程步骤

```
回测流程:

[1] 数据加载
    └─ 从SQLite加载指定日期范围的日线数据
    
[2] 基本面数据预处理
    └─ 预加载所有股票的基本面数据
    
[3] 逐日迭代
    for each trading_day in dates[60:]:
        
        a. 检测市场环境
           ├─ 计算沪深300成分股60日平均涨幅
           ├─ 涨幅 > 15% → 牛市
           ├─ 涨幅 < -15% → 熊市
           └─ 其他 → 震荡市
        
        b. 选择策略
           └─ 根据市场环境从策略库选择
        
        c. 筛选候选股票
           ├─ 排除已持仓股票
           └─ 基本面过滤
        
        d. 计算信号分数
           └─ 对候选股票计算技术指标分数
        
        e. 买入决策
           ├─ 分数 >= 阈值 → 买入
           ├─ 选择分数最高的股票
           └─ 资金充足时执行
        
        f. 持仓检查
           ├─ 止盈检查: 收益>=20% → 卖出
           ├─ 止损检查: 收益<=-10% → 卖出
           └─ 到期检查: 持仓>60天 → 卖出
        
        g. 更新权益
           └─ 计算当日账户总值

[4] 结果输出
    └─ 计算并输出绩效指标
```

### 3.4 绩效指标

| 指标 | 说明 |
|------|------|
| Total Return | 总收益率 |
| Annual Return | 年化收益率 |
| Max Drawdown | 最大回撤 |
| Avg Drawdown | 平均回撤 |
| Win Rate | 胜率 |
| Trade Count | 交易次数 |
| Std Return | 收益标准差 |

---

## 四、策略说明 (以RSI策略为例)

### 4.1 策略原理

RSI (Relative Strength Index) 相对强弱指标，通过计算一定周期内股价涨跌幅度对比来判断股票的强弱。

### 4.2 信号计算公式

```
RSI = 100 - (100 / (1 + RS))
RS = 平均涨幅 / 平均跌幅
```

### 4.3 买入信号

- RSI < 30: 超卖区域，可能反弹
- RSI < 40: 轻度超卖

### 4.4 卖出信号

- RSI > 70: 超买区域，可能回调
- RSI > 60: 轻度超买

### 4.5 通用策略框架

```python
def calculate_signal(historical_data, strategy_name, signal_type):
    """
    统一的信号计算接口
    
    Args:
        historical_data: DataFrame (OHLCV)
        strategy_name: 策略名称
        signal_type: 'buy' 或 'sell'
    
    Returns:
        float: 信号分数 (0-100)
    """
    # 1. 计算技术指标
    indicators = calculate_indicators(historical_data)
    
    # 2. 应用策略规则
    score = apply_strategy_rules(indicators, strategy_name, signal_type)
    
    # 3. 归一化到0-100
    return normalize_score(score)
```

---

## 五、系统文件结构

```
trading-system-v2/
├── data/
│   └── stocks.db              # SQLite数据库
├── src/
│   ├── unified_backtest.py    # 统一回测系统
│   ├── run_trading.py        # 实盘交易脚本
│   ├── market_regime.py      # 市场环境检测
│   ├── signal_strength.py    # 信号计算
│   ├── strategies/           # 23个独立策略
│   │   ├── rsi.py
│   │   ├── ma.py
│   │   ├── bollinger_bands.py
│   │   └── ...
│   └── ...
├── scripts/
│   └── optimize_*.py         # 参数优化脚本
├── config/
│   └── ...
└── docs/
    └── ...
```

---

## 六、注意事项

1. **T+1制度**: 当日买入股票，次日才能卖出
2. **手续费**: 假设千分之一印花税+佣金
3. **滑点**: 假设1%的滑点成本
4. **数据延迟**: 实盘需要考虑数据延迟
5. **风险管理**: 单股仓位不超过10%，总持仓不超过5只

---

## 七、版本信息

- 版本: 2.0
- 更新日期: 2026-02-24
- 项目位置: `/root/.openclaw/workspace/trading-system-v2/`
